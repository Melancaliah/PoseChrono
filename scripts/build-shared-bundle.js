#!/usr/bin/env node
/* eslint-disable no-console */
const fs = require("fs");
const fsp = require("fs/promises");
const path = require("path");

const ROOT = path.resolve(__dirname, "..");
const INDEX_HTML_PATH = path.join(ROOT, "index.html");
const SHARED_DIR = path.join(ROOT, "packages", "shared");
const SHARED_BUNDLE_PATH = path.join(SHARED_DIR, "shared.bundle.js");
const SHARED_PREFIX = "packages/shared/";
const BUNDLE_NAME = "shared.bundle.js";
const DEFAULT_SHARED_ORDER = [
  "frame-mode-detection.js",
  "preferences-core.js",
  "ui-preferences.js",
  "i18n-utils.js",
  "i18n-loader-utils.js",
  "dom-safety-utils.js",
  "storage-adapter.js",
  "runtime-mode-utils.js",
  "sync-transport-mock.js",
  "sync-transport-websocket.js",
  "sync-transport-webrtc.js",
  "sync-session-core.js",
  "preferences-transfer-utils.js",
  "platform-access-utils.js",
  "platform-capability-utils.js",
  "platform-ops-utils.js",
  "platform-window-utils.js",
  "image-context-menu-bindings-utils.js",
  "action-buttons-bindings-utils.js",
  "session-plan-utils.js",
  "session-metrics.js",
  "session-controls-bindings-utils.js",
  "session-surface-interactions-bindings-utils.js",
  "custom-session-utils.js",
  "session-flow-utils.js",
  "timer-tick-utils.js",
  "review-session-utils.js",
  "review-grid-utils.js",
  "review-interactions-utils.js",
  "screen-context-menu-bindings-utils.js",
  "session-replay-utils.js",
  "session-media-utils.js",
  "session-mode-ui-utils.js",
  "sidebar-tooltips-utils.js",
  "keyboard-listener-bindings-utils.js",
  "global-keyboard-shortcuts-utils.js",
  "main-keyboard-shortcuts-utils.js",
  "settings-shortcuts-utils.js",
  "session-time-format-utils.js",
  "session-duration-buttons-utils.js",
  "session-time-input-utils.js",
  "hotkeys-utils.js",
  "storage-diagnostics-utils.js",
  "timeline-sanitizer-utils.js",
  "timeline-date-utils.js",
  "timeline-media-utils.js",
  "timeline-display-utils.js",
  "timeline-feedback-utils.js",
  "timeline-format-utils.js",
];

function toUnixPath(input) {
  return String(input || "").split(path.sep).join("/");
}

function parseSharedScriptOrder(indexHtmlRaw) {
  const out = [];
  const regex = /<script[^>]+src="([^"]+)"[^>]*><\/script>/gim;
  let match = regex.exec(indexHtmlRaw);
  while (match) {
    const src = String(match[1] || "").trim();
    if (src.startsWith(SHARED_PREFIX) && src.endsWith(".js")) {
      const rel = src.slice(SHARED_PREFIX.length);
      if (rel && rel !== BUNDLE_NAME) out.push(rel);
    }
    match = regex.exec(indexHtmlRaw);
  }
  return out;
}

function uniquePreserveOrder(values) {
  const seen = new Set();
  const out = [];
  values.forEach((value) => {
    const key = String(value || "").trim();
    if (!key || seen.has(key)) return;
    seen.add(key);
    out.push(key);
  });
  return out;
}

async function main() {
  const indexRaw = await fsp.readFile(INDEX_HTML_PATH, "utf8");
  const ordered = uniquePreserveOrder(parseSharedScriptOrder(indexRaw));
  const sourceOrder =
    ordered.length > 0 ? ordered : DEFAULT_SHARED_ORDER.slice();
  if (sourceOrder.length === 0) {
    throw new Error("[build:shared-bundle] Shared source order is empty.");
  }

  const chunks = [];
  chunks.push("/* Auto-generated by scripts/build-shared-bundle.js */");
  chunks.push(`/* Sources: ${sourceOrder.length} files */`);
  chunks.push("");

  for (const rel of sourceOrder) {
    const sourcePath = path.join(SHARED_DIR, rel);
    if (!fs.existsSync(sourcePath)) {
      throw new Error(`[build:shared-bundle] Missing source: ${toUnixPath(sourcePath)}`);
    }
    const sourceRaw = await fsp.readFile(sourcePath, "utf8");
    chunks.push(`/* ===== ${toUnixPath(path.join("packages", "shared", rel))} ===== */`);
    chunks.push(sourceRaw.trimEnd());
    chunks.push("");
  }

  const output = `${chunks.join("\n")}\n`;
  await fsp.writeFile(SHARED_BUNDLE_PATH, output, "utf8");

  const stat = await fsp.stat(SHARED_BUNDLE_PATH);
  console.log("[build:shared-bundle] OK");
  console.log(
    `[build:shared-bundle] Output: ${toUnixPath(path.relative(ROOT, SHARED_BUNDLE_PATH))}`,
  );
  console.log(
    `[build:shared-bundle] Sources: ${sourceOrder.length} | Size: ${(stat.size / 1024).toFixed(1)} KB`,
  );
}

main().catch((error) => {
  console.error("[build:shared-bundle] Failed:", error);
  process.exitCode = 1;
});
